# Новый Workflow сохранения данных

## Проблема (БЫЛО):
```
1. astrology_handlers.py → content (сырые данные API)
2. astrology_handlers.py → moon_analysis (дублирование!)
3. worker.py → content (ПЕРЕЗАПИСЬ результатом LLM)
4. Результат: данные перезаписываются, путаница где что лежит
```

## Решение (СТАЛО):
```
1. astrology_handlers.py → content (только сырые данные API)
2. worker.py → moon_analysis (результат LLM в правильный столбец)
3. worker.py → format_prediction_message читает из moon_analysis
4. Результат: данные не перезаписываются, четкое разделение
```

## Детальный Workflow:

### Шаг 1: Создание предсказания (astrology_handlers.py)
```
Пользователь нажимает "Начнем"
↓
Получаем данные от AstrologyAPI
↓
Сохраняем в Prediction:
  - content = сырые данные API
  - planet = moon
  - prediction_type = free
  - moon_analysis = NULL (пока)
↓
Отправляем в очередь RabbitMQ
```

### Шаг 2: Обработка воркером (worker.py)
```
Получаем сообщение из очереди
↓
Читаем prediction.content (сырые данные)
↓
Отправляем в OpenRouter LLM
↓
Получаем результат от LLM
↓
Сохраняем в prediction.moon_analysis (НЕ перезаписываем content!)
↓
Отправляем пользователю сообщение с кнопками
```

### Шаг 3: Отображение пользователю
```
format_prediction_message читает:
  - prediction.moon_analysis (результат LLM)
  - НЕ prediction.content (сырые данные)
↓
Формирует красивое сообщение
↓
Отправляет с кнопками "Получить рекомендации", "Задать вопрос"
```

## Преимущества нового подхода:

✅ **Нет перезаписи** - content остается с сырыми данными API
✅ **Четкое разделение** - каждый тип данных в своем столбце  
✅ **Совместимость** - старый код продолжит работать
✅ **Масштабируемость** - легко добавлять новые планеты
✅ **Отладка** - можно посмотреть и сырые данные, и результат LLM

## Структура данных в БД:

```sql
-- После обработки Луны:
content = "Moon Analysis Data: Луна в знаке... Raw AstrologyAPI data: {...}"
moon_analysis = "Привет, Анна! Твоя Луна в Раке говорит о том, что..."
sun_analysis = NULL
mercury_analysis = NULL
-- и т.д.
```

## Проверка работы:

1. **Создайте предсказание** - проверьте, что content заполнен, moon_analysis = NULL
2. **Запустите воркера** - проверьте, что moon_analysis заполнился, content не изменился  
3. **Пользователь получил сообщение** - проверьте, что отображается результат LLM
4. **Кнопки работают** - проверьте, что можно получить рекомендации
