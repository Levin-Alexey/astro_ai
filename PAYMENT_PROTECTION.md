# –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ—Ç–µ—Ä–∏ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö —Ä–∞–∑–±–æ—Ä–æ–≤

## üõ°Ô∏è –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ —Å–±–æ–µ LLM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç –¥–µ–Ω—å–≥–∏, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–±–æ—Ä –ø–ª–∞–Ω–µ—Ç—ã. –î–µ–Ω—å–≥–∏ "–ø—Ä–æ–ø–∞–¥–∞—é—Ç".

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π
–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã –≤ `PaymentStatus`:
- `processing` - –†–∞–∑–±–æ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è LLM
- `analysis_failed` - –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞, –Ω–æ LLM –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
- `delivered` - –†–∞–∑–±–æ—Ä –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 2. –ü–æ–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤ `PlanetPayment`
```sql
analysis_started_at TIMESTAMP    -- –ö–æ–≥–¥–∞ –Ω–∞—á–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É
analysis_completed_at TIMESTAMP  -- –ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É  
delivered_at TIMESTAMP          -- –ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∞–≤–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
retry_count INTEGER             -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
last_error TEXT                -- –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞
```

### 3. –ú–æ–¥—É–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ `payment_access.py`
- `check_planet_access()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–∑–±–æ—Ä—É
- `mark_analysis_started()` - –æ—Ç–º–µ—á–∞–µ—Ç –Ω–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `mark_analysis_completed()` - –æ—Ç–º–µ—á–∞–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- `mark_analysis_failed()` - –æ—Ç–º–µ—á–∞–µ—Ç –æ—à–∏–±–∫—É
- `get_failed_payments()` - –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

### 4. –õ–æ–≥–∏–∫–∞ –∑–∞—â–∏—Ç—ã

#### –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ä–∞–∑–±–æ—Ä–∞ –ø–ª–∞–Ω–µ—Ç—ã:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
2. –ï—Å–ª–∏ `delivered` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–æ—Ç–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä
3. –ï—Å–ª–∏ `processing` ‚Üí "–†–∞–∑–±–æ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è..."
4. –ï—Å–ª–∏ `analysis_failed` ‚Üí "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å?"
5. –ï—Å–ª–∏ `completed` ‚Üí –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
6. –ï—Å–ª–∏ –Ω–µ—Ç –ø–ª–∞—Ç–µ–∂–∞ ‚Üí –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–ø–ª–∞—Ç—É

#### –í –≤–æ—Ä–∫–µ—Ä–µ LLM:
1. –ù–∞—Ö–æ–¥–∏–º –ø–ª–∞—Ç–µ–∂ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –ø–ª–∞–Ω–µ—Ç–µ
2. –û—Ç–º–µ—á–∞–µ–º `processing` + `analysis_started_at`
3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ LLM
4. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: `delivered` + `delivered_at`
5. –ü—Ä–∏ –æ—à–∏–±–∫–µ: `analysis_failed` + `last_error`

### 5. –ö–Ω–æ–ø–∫–∞ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑"
–ï—Å–ª–∏ —Ä–∞–∑–±–æ—Ä –Ω–µ —É–¥–∞–ª—Å—è (`analysis_failed`), –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:
```
üòî –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∞—à–µ–≥–æ —Ä–∞–∑–±–æ—Ä–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞.
üíù –ù–æ –Ω–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å - —Ä–∞–∑–±–æ—Ä —É–∂–µ –æ–ø–ª–∞—á–µ–Ω! 
–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –º—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ –µ—â–µ —Ä–∞–∑?
[üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –µ—â–µ —Ä–∞–∑]
```

### 6. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
–°–∫—Ä–∏–ø—Ç `retry_failed_payments.py`:
- –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `analysis_failed`
- –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç ‚Üí LLM –ø–∞–¥–∞–µ—Ç ‚Üí –¥–µ–Ω—å–≥–∏ –ø—Ä–æ–ø–∞–ª–∏
- –ù—É–∂–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–µ–Ω—å–≥–∏ –∏–ª–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–∞–∑–±–æ—Ä –≤—Ä—É—á–Ω—É—é

### –ü–æ—Å–ª–µ:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–ª–∞—Ç–∏—Ç ‚Üí LLM –ø–∞–¥–∞–µ—Ç ‚Üí "–†–∞–∑–±–æ—Ä –Ω–µ —É–¥–∞–ª—Å—è, –ø–æ–≤—Ç–æ—Ä–∏—Ç—å?"
- –î–µ–Ω—å–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü–æ–ª–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üîß –í–Ω–µ–¥—Ä–µ–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
```bash
python migrate_payment_tracking.py
```

2. –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞–Ω–µ—Ç –≤ `main.py` (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `payment_access.py`)

3. –û–±–Ω–æ–≤–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã LLM –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
```bash
*/30 * * * * cd /path/to/astro && python retry_failed_payments.py
```

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É** –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö —Å–±–æ—è—Ö
- **–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏** –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö  
- **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** –ø–æ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å** –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫